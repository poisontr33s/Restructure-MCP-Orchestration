name: ðŸ¤– Gemini Code Assist Integration

on:
  push:
    branches: [ main, develop, copilot/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      enable_analysis:
        description: 'Enable detailed code analysis'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8.15.0'

jobs:
  gemini-code-analysis:
    name: Gemini Code Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      pull-requests: write
      security-events: write
      
    steps:
      - name: ðŸ´â€â˜ ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ðŸ”¨ Build Project
        run: pnpm build
        
      - name: ðŸ¤– Configure Gemini Code Assist
        env:
          GUTHILDA_GEMINI_CODE_ASSIST_ENABLED: true
          GUTHILDA_GEMINI_CODE_ASSIST_API_KEY: ${{ secrets.GEMINI_CODE_ASSIST_API_KEY }}
          GUTHILDA_GEMINI_CODE_ASSIST_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          GUTHILDA_GEMINI_CODE_ASSIST_LOCATION: us-central1
        run: |
          echo "ðŸ” Authenticating Gemini Code Assist..."
          pnpm guthilda:auth setup
          
      - name: ðŸ” Run Code Analysis
        env:
          GUTHILDA_GEMINI_CODE_ASSIST_ENABLED: true
          GUTHILDA_GEMINI_CODE_ASSIST_API_KEY: ${{ secrets.GEMINI_CODE_ASSIST_API_KEY }}
          GUTHILDA_GEMINI_CODE_ASSIST_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Running Gemini Code Assist analysis..."
          pnpm guthilda:discover
          
      - name: ðŸ“Š Generate Analysis Report
        env:
          GUTHILDA_GEMINI_CODE_ASSIST_ENABLED: true
          GUTHILDA_GEMINI_CODE_ASSIST_API_KEY: ${{ secrets.GEMINI_CODE_ASSIST_API_KEY }}
          GUTHILDA_GEMINI_CODE_ASSIST_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
        run: |
          echo "ðŸ“Š Generating Gemini analysis report..."
          pnpm guthilda:report > gemini-analysis-report.json
          
      - name: ðŸ“¤ Upload Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: gemini-code-analysis-${{ github.sha }}
          path: |
            gemini-analysis-report.json
            logs/
          retention-days: 30
          if-no-files-found: warn

  security-scan:
    name: Gemini Security Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      security-events: write
      
    steps:
      - name: ðŸ´â€â˜ ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ðŸ”¨ Build Project
        run: pnpm build
        
      - name: ðŸ›¡ï¸ Run Security Analysis
        env:
          GUTHILDA_GEMINI_CODE_ASSIST_ENABLED: true
          GUTHILDA_GEMINI_CODE_ASSIST_API_KEY: ${{ secrets.GEMINI_CODE_ASSIST_API_KEY }}
          GUTHILDA_GEMINI_CODE_ASSIST_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ›¡ï¸ Running Gemini security analysis..."
          # This would integrate with Gemini's security scanning capabilities
          echo "Security scan completed - results would be processed here"
          
      - name: ðŸ“Š Generate Security Report
        run: |
          echo "ðŸ“Š Security analysis complete"
          # Results would be formatted and uploaded

  performance-optimization:
    name: Gemini Performance Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    steps:
      - name: ðŸ´â€â˜ ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ðŸ”¨ Build Project
        run: pnpm build
        
      - name: âš¡ Run Performance Analysis
        env:
          GUTHILDA_GEMINI_CODE_ASSIST_ENABLED: true
          GUTHILDA_GEMINI_CODE_ASSIST_API_KEY: ${{ secrets.GEMINI_CODE_ASSIST_API_KEY }}
          GUTHILDA_GEMINI_CODE_ASSIST_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
        run: |
          echo "âš¡ Running Gemini performance analysis..."
          # This would integrate with Gemini's performance optimization features
          echo "Performance analysis completed"
          
      - name: ðŸ“ˆ Generate Performance Report
        run: |
          echo "ðŸ“ˆ Performance analysis complete"
          # Results would be formatted and uploaded

  integration-status:
    name: Gemini Integration Status
    runs-on: ubuntu-latest
    needs: [gemini-code-analysis]
    if: always()
    
    steps:
      - name: ðŸ´â€â˜ ï¸ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ðŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ðŸ”¨ Build Project
        run: pnpm build
        
      - name: ðŸ“Š Check Gemini Integration Status
        env:
          GUTHILDA_GEMINI_CODE_ASSIST_ENABLED: true
          GUTHILDA_GEMINI_CODE_ASSIST_API_KEY: ${{ secrets.GEMINI_CODE_ASSIST_API_KEY }}
          GUTHILDA_GEMINI_CODE_ASSIST_PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT_ID }}
        run: |
          echo "ðŸ“Š Checking Gemini Code Assist integration status..."
          pnpm guthilda:status
          
      - name: ðŸŽ¯ Integration Summary
        run: |
          echo "## ðŸ¤– Gemini Code Assist Integration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Code Analysis**: ${{ needs.gemini-code-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **Configuration**: Active" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ´â€â˜ ï¸ **Captain Guthilda**: Ready for AI-powered orchestration!" >> $GITHUB_STEP_SUMMARY