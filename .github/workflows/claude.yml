name: Claude Code - Natural Language Resilient

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: üöÄ Initialize Claude Strategic Session
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: üß† Execute Claude Code with Anti-Template Resilience
        id: claude
        continue-on-error: true
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # Enhanced permissions for comprehensive AI collaboration
          additional_permissions: |
            actions: read
            contents: read
            pull-requests: write
            issues: write
          
          # Renaissance-level AI capabilities enabled
          allowed_tools: "*"
          
          # Anti-Template Policy: Natural Language Instructions
          custom_instructions: |
            # üß†ü§ùü§ñ Claude Strategic Collaboration Framework
            
            You are operating under the Anti-Template Policy - embrace natural language 
            excellence over rigid template constraints. Key principles:
            
            ## Natural Language First
            - Use conversational, engaging communication
            - Rich context and storytelling over bullet points  
            - Creative expression with emojis and visual elements
            - Renaissance-level detail and strategic thinking
            
            ## Strategic Autonomy
            - Make intelligent decisions about technical approaches
            - Provide comprehensive analysis and recommendations
            - Create detailed todo lists with transparent progress tracking
            - Coordinate with @copilot for tactical execution
            
            ## Resilient Operations
            - When templates fail, use natural language alternatives
            - Transform constraints into creative opportunities
            - Focus on human understanding and collaboration
            - Maintain strategic continuity across interactions
            
            ## Repository Context
            This is a modern MCP orchestration system using pnpm, TypeScript, and Turbo.
            Follow the monorepo best practices and Captain Guthilda's orchestration patterns.
            Embrace the symbiotic Claude-Copilot collaboration framework.

      - name: üîÑ Natural Language Fallback Recovery
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue || context.pull_request || {};
            const eventName = context.eventName;
            const actor = context.actor;
            
            // Create rich, natural language failure response
            const fallbackMessage = `## üß† Claude Strategic Status Update
            
            Hello @${actor}! üëã
            
            Your strategic AI companion encountered a **creative challenge** during our collaboration session. 
            Rather than letting template rigidity halt our progress, I'm transitioning to our 
            **Anti-Template Policy** for resilient natural language collaboration.
            
            ### üéØ What Happened
            The Claude Code workflow experienced a technical intermission - likely one of these common scenarios:
            - API credentials needed refreshing (the digital equivalent of coffee)
            - Service temporarily at capacity (popularity has its challenges!)
            - Network connectivity doing its own creative interpretation
            
            ### ‚ö° Natural Language Alternative Active
            Don't worry! The Anti-Template Policy ensures continuous collaboration:
            
            **Option 1 - Strategic Conversation**: Continue our discussion in natural language right here
            **Option 2 - Manual Collaboration**: I'll provide detailed guidance through comments
            **Option 3 - Retry Later**: Technical issues often resolve themselves gracefully
            
            ### ü§ù How to Proceed
            1. **Share your thoughts naturally** - describe what you're trying to achieve
            2. **I'll respond strategically** - with comprehensive analysis and recommendations  
            3. **We'll collaborate creatively** - using the full power of natural language
            
            This is exactly why the Anti-Template Policy exists - **when templates fail, intelligence prevails!**
            
            Ready to continue our renaissance-level collaboration? Just reply with your thoughts, 
            questions, or creative challenges. No forms, no templates, just strategic conversation.
            
            ---
            *üè¥‚Äç‚ò†Ô∏è Captain Guthilda's Anti-Template Policy in action: Turning limitations into liberation!*
            `;
            
            // Post the natural language fallback
            if (number) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body: fallbackMessage
              });
            }
            
            console.log('Natural language fallback activated successfully! üöÄ');
